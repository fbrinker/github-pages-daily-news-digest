<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title }} - {{ site.title }}</title>
  <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
</head>
<body>
  {% include header.html %}

  <nav class="floating-nav" id="floating-nav">
    <button class="floating-menu-toggle" id="floating-menu-toggle" aria-label="Inhaltsverzeichnis öffnen">
      <span>Inhalt</span>
      <span class="toggle-icon">▼</span>
    </button>
    <ul id="toc-list" class="toc-list"></ul>
  </nav>

  <main class="post-content">
    <article>
      <header class="post-header">
        <h1>{{ page.title }}</h1>
        <time datetime="{{ page.date | date: '%Y-%m-%d' }}">{{ page.date | date: "%d. %B %Y" }}</time>
        {% assign words = page.content | number_of_words %}
        {% assign minutes = words | divided_by: 225 %}
        <p class="total-reading-time">
          {% if minutes < 1 %}
            Ungefähre Gesamtlesezeit: < 1 min
          {% else %}
            Ungefähre Gesamtlesezeit: {{ minutes }} min
          {% endif %}
        </p>
      </header>

      <div class="post-body">
        {%- capture bing_image -%}
          {% include image_of_the_day.html url=page.iotd_bing_url description=page.iotd_bing_description %}
        {%- endcapture -%}

        {%- capture nasa_image -%}
          {% include image_of_the_day.html url=page.iotd_nasa_url description=page.iotd_nasa_description %}
        {%- endcapture -%}

        {{ page.content | replace: "<bing>", bing_image | replace: "<nasa>", nasa_image | markdownify }}
      </div>
    </article>
  </main>

  {% include footer.html %}

  <script>
    // Automatically generate table of contents and insert into navigation
    document.addEventListener('DOMContentLoaded', function() {
      const postBody = document.querySelector('.post-body');
      if (!postBody) return;

      const headings = postBody.querySelectorAll('h3');
      const tocList = document.getElementById('toc-list');

      if (headings.length === 0) {
        // No headings found, hide navigation
        const floatingNav = document.getElementById('floating-nav');
        if (floatingNav) floatingNav.style.display = 'none';
        return;
      }

      // Function to filter: retain only allowed characters
      function filterAllowedChars(text) {
        // Allowed: letters (incl. umlauts), numbers, spaces, common punctuation
        // Pattern allows Unicode letters, numbers, spaces, and punctuation
        return text.replace(/[^\p{L}\p{N}\s\-.,:;!?()&]/gu, '').trim();
      }

      const readingTimeRegex = /\s*\((?:\d+min(?:\s+\d+s)?|\d+s)\)$/;

      headings.forEach(function(heading) {
        let originalText = heading.textContent.trim();
        let tocText = originalText.replace(readingTimeRegex, '').trim();

        // Wrap reading time in a span for styling
        heading.innerHTML = originalText.replace(readingTimeRegex, '<span class="reading-time">$&</span>');

        // Generate ID for the heading (without reading time)
        const filteredText = filterAllowedChars(tocText);

        let id = filteredText.toLowerCase()
          .replace(/[\s,.:!?()]+/g, '-') // Replace spaces and punctuation with single hyphens
          .replace(/&/g, 'und')         // Replace '&' with 'und'
          .replace(/^-+|-+$/g, '');     // Remove leading/trailing hyphens

        // Ensure unique ID
        let uniqueId = id;
        let counter = 1;
        while (document.getElementById(uniqueId)) {
          uniqueId = id + '-' + counter;
          counter++;
        }

        heading.id = uniqueId;

        // Add link to TOC in navigation (only filtered here)
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + uniqueId;
        a.textContent = filteredText;
        li.appendChild(a);
        tocList.appendChild(li);
      });

      // Floating menu toggle
      const menuToggle = document.getElementById('floating-menu-toggle');
      const tocListElement = document.getElementById('toc-list');

      if (menuToggle && tocListElement) {
        menuToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          tocListElement.classList.toggle('active');
          menuToggle.classList.toggle('active');
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
          if (!tocListElement.contains(e.target) && !menuToggle.contains(e.target)) {
            tocListElement.classList.remove('active');
            menuToggle.classList.remove('active');
          }
        });

        // Close menu when clicking on a link
        tocListElement.addEventListener('click', function(e) {
          if (e.target.tagName === 'A') {
            tocListElement.classList.remove('active');
            menuToggle.classList.remove('active');
          }
        });
      }
    });
  </script>
</body>
</html>

